services:
  redis:
    image: redis:latest
    container_name: redis_server
    ports:
      - "6379:6379"  # –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ—Ä—Ç Redis
    volumes:
      - redis_data:/data  # –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö Redis

  bot:
    build:
      context: .
    ports:
      - "8080:8080"
    container_name: bot_server
    depends_on:
      - redis
      - postgres
    environment:
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}

  nginx:
    image: nginx:latest
    container_name: nginx_server
    ports:
      - "80:80"
    volumes:
      - ./nginx_setup/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - bot

  postgres:
    image: postgres:latest
    container_name: postgres_server
    restart: always
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: bot_db
      POSTGRES_USER: bot_user
      POSTGRES_PASSWORD: bot_password
    volumes:
      - postgres_data:/var/lib/postgresql/data  # –•—Ä–∞–Ω–µ–Ω–∏–µ –ë–î
      - ./backups:/backups  # –•—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π




  postgres_backup:
    image: postgres:latest
    container_name: backup_service
    depends_on:
      - postgres
    volumes:
      - ./backups:/backups
    environment:
      - PGPASSWORD=${POSTGRES_PASSWORD}
    command: >
      sh -c '
        while true; do
          echo "üìÇ –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞–Ω–æ–≤–æ–≥–æ –±—ç–∫–∞–ø–∞...";
          pg_dump -h postgres -U ${POSTGRES_USER} ${POSTGRES_DB} > /backups/backup_$(date +%F_%H-%M-%S).sql;
          echo "‚úÖ –ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω.";
          sleep 1800;
          echo "üßπ –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤...";
          find /backups -type f -mmin +144 -exec rm {} \;
          echo "‚úÖ –°—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã —É–¥–∞–ª–µ–Ω—ã.";
        done'
    restart: always

volumes:
  redis_data:
  postgres_data:
